name: 'üöÄ CD ‚Ä¢ Fly.io ‚Ä¢ Infra Provision'
description: 'Continuous delivery action to provision Fly.io infrastructure using flyctl'

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        default: 'dev'
        description: 'Select deployment environment'
        options: ['dev', 'qa', 'prod']
        required: true
      launch-aws-resources:
        type: boolean
        default: false
        description: 'Launch AWS resources'
        required: true

jobs:
  fly-io_infra_provision:
    name: ü™Ç Fly.io Infra Provision
    runs-on: ubuntu-22.04
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP: 'go-fiber-app'
      NETWORK: 'go-fiber-nw'
      ORG: 'personal'
      VOLUME: 'go_fiber_volume'
      REGION: 'fra'
    defaults:
      run:
        shell: bash
    steps:
      - name: Step - Checkout
        uses: actions/checkout@v3
        with:
          repository: '${{ github.repository }}'
          token: '${{ github.token }}'
      - name: Step - flyctl Setup ·µõ‚Å∞¬∑¬≥¬∑¬π‚Å∂‚Å∑
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: 0.3.167
      - name: Step - Create Fly.io App
        run: |
          if [ "$(flyctl apps list --org="$ORG" --json | jq --arg app "$APP" '[.[] | select((.name // "" | ascii_downcase) == ($app | ascii_downcase))] | length')" -eq 0 ]; then
            flyctl apps create --name="$APP" --network="$NETWORK" --org="$ORG" --yes
          fi
      - name: Step - Create Fly.io Volume
        run: |
          if [ "$(flyctl volumes list --app="$APP" --json | jq length)" -eq 0 ]; then
            flyctl volumes create "$VOLUME" --app="$APP" --count=1 --no-encryption --region="$REGION" --require-unique-zone=false --size=1 --snapshot-retention=1 --vm-cpu-kind="shared" --vm-cpus=1 --vm-memory="256mb" --vm-size="shared-cpu-1x" --yes
          fi
