---
name: ğŸš€ WebApp deployment using Terraform.
on:
  push:
    branches:
      - main
  #pull_request:
    #branches:
      #- main
env:
  # Setting verbosity of Terraform logs.
  TF_LOG: ERROR
  # Setting AWS Access Key Id and Secret Access Key.
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
jobs:
  terraform:
    name: ğŸ› ï¸ Running Terraform
    # GitHub Actions runner is ubuntu-22.04.
    runs-on: ubuntu-22.04
    # Environment is Development.
    environment: dev
    defaults:
      run:
        # Using bash shell.
        shell: bash
        # Setting working directory.
        # Also, by keeping '.' setting current terraform files running directory.
        working-directory: .
    steps:
      # Checkout a Git repository at a particular version.
      - name: ğŸ™ Git Checkout ğŸ“¥
        uses: actions/checkout@v3
        with:
          # Repository name with owner.
          repository: '${{ github.repository }}'
          # PAT (Personal Access Token) used to fetch the repository.
          token: '${{ github.token }}'
          # Whether to execute `git clean -ffdx && git reset --hard HEAD` before fetching.
          clean: true
          # Do a sparse checkout on given patterns.
          sparse-checkout: null
          # Specifies whether to use cone-mode when doing a sparse checkout.
          sparse-checkout-cone-mode: true
          # Number of commits to fetch.
          fetch-depth: 1
          # Whether to fetch tags, even if fetch-depth > 0.
          fetch-tags: false
          # Whether to download Git-LFS files
          lfs: false
          # Add repository path as safe.
          set-safe-directory: true
      # Gets the public IPv4 and IPv6 addreses of the current runner using latest Node
      - name: ğŸŒ Get Runner Public IP Address ğŸ“¡
        uses: candidob/get-runner-ip@v1.0.0
        id: ip
      # Preparing and pushing documetation into README.md
      #- name: Prepare Terraform Doc and Push to README.md
        #uses: terraform-docs/gh-actions@main
        #with:
          #working-dir: .
          #output-file: README.md
          #output-method: inject
          #git-push: "true"
      # Installing the specified version of Terraform CLI on Runner.
      - name: ğŸ› ï¸ Terraform setup ğŸ“
        uses: hashicorp/setup-terraform@v2
        with:
          #cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: 1.4.0
          #terraform_wrapper: false
      # Initialize a new or existing Terraform working directory by creating initial files,
      # loading any remote state, downloading modules, etc.
      - name: ğŸ› ï¸ Terraform initialization ğŸ”
        run: terraform init -input=false -reconfigure
        #shell: bash
        env:
          TF_WORKSPACE: default
      # Format Terraform configuration files adhere in to a canonical format.
      - name: ğŸ› ï¸ Terraform files formating ğŸ§¹
        run: terraform fmt
      # Check that all Terraform configuration files adhere to a canonical format.
      - name: ğŸ› ï¸ Terraform file format checking ğŸ”
        run: terraform fmt -check
      # Validate all Terraform configuration files.
      - name: ğŸ› ï¸ Terraform files validating âœ…
        run: terraform validate -no-color
      # Generates an execution plan for Terraform.
      - name: ğŸ› ï¸ Terraform plan generation ğŸ“„
        run: |
          terraform plan -input=false -out=webapp.tfplan                              \
            -var="github_runner_ip=${{ steps.ip.outputs.ipv4 }}/32"                   \
            -var="webapp_database_name=${{ secrets.WEBAPP_DB_NAME }}"                 \
            -var="webapp_db_master_username=${{ secrets.WEBAPP_DB_MASTER_USERNAME }}" \
            -var="webapp_db_master_password=${{ secrets.WEBAPP_DB_MASTER_PASSWORD }}"
        #continue-on-error: true
      # Apply an execution plan for Terraform.
      - name: ğŸ› ï¸ Terraform plan applying ğŸš§
        run: terraform apply -auto-approve -input=false webapp.tfplan
      # Destroy an execution plan for Terraform.
      #- name: ğŸ› ï¸ Terraform plan ğŸ”¥ destroying âš ï¸
        #run: terraform apply -auto-approve -input=false -destroy

      # Deploy any changes in the changelog file that have not been deployed
      #- name: ğŸ›¢ Liquibase Update Action ğ„œ
        #uses: liquibase-github-actions/update@v4.32.0
        #with:
          # The root changelog.
          #changelogFile: "./postgresql/webapp_db/public/master.xml"
          # The JDBC database connection URL.
          #url: "jdbc:postgresql://${{ secrets.WEBAPP_DB_MASTER_URL }}:5432/${{ secrets.WEBAPP_DB_NAME }}"
          # The default schema name to use for the database connection.
          #defaultSchemaName: "public"
          # The JDBC driver class
          #driver: "org.postgresql.Driver"
          # Password to use to connect to the database.
          #password: ${{ secrets.WEBAPP_DB_MASTER_PASSWORD }}
          # Rollback all changesets if any fails.
          #rollbackOnError: true
          # Type of update results summary to show.
          # Values can be "off", "summary", or "verbose".
          #showSummary: "summary"
          # Summary output to report update summary results.
          # Values can be "log", "console", or "all".
          #showSummaryOutput: "console"
          # Username to use to connect to the database.
          #username: ${{ secrets.WEBAPP_DB_MASTER_USERNAME }}
          # Additional classpath entries to use.
          #classpath: "./postgresql/webapp_db/public"
      #- name: Terraform plan generation for `github_runner_to_pg_webapp_db_sg` module.
        #run: terraform plan -input=false -out=webapp.tfplan
      #- name: Terraform plan apply for `github_runner_to_pg_webapp_db_sg` module.
        #run: terraform apply -auto-approve -input=false -target=module.github_runner_to_pg_webapp_db_sg.aws_security_group.generic

      # GitHub Action to login against a Docker registry.
      - name: ğŸ³ Docker Login ğŸ”
        uses: docker/login-action@v3
        with:
          # Server address of Docker registry.
          registry: 'docker.io'
          # Username used to log against the Docker registry.
          username: ${{ vars.DOCKERHUB_USERNAME }}
          # Password or PAT (Personal Access Token) used to log against the Docker registry.
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          # Specifies whether the given registry is ECR.
          # Valid values: `auto`, `true` or `false`
          ecr: auto
          # Log out from the Docker registry at the end of a job.
          logout: true
      # Install QEMU (Quick EMUlator) static binaries.
      - name: ğŸ³ Docker Setup QEMU ğŸ§ 
        uses: docker/setup-qemu-action@v3
        with:
          # QEMU static binaries Docker image.
          image: 'docker.io/tonistiigi/binfmt:latest'
          # Platforms to install (e.g. arm64,riscv64,arm)
          platforms: all
          # Cache binfmt image to GitHub Actions cache backend.
          cache-image: true
      # Install QEMU (Quick EMUlator) static binaries.
      - name: ğŸ³ Docker Setup Buildx ğŸ§°
        uses: docker/setup-buildx-action@v3
        with:
          # Sets the builder driver to be used.
          driver: 'docker-container'
          # Sets up docker build command as an alias to docker buildx build.
          install: false
          # Switch to this builder instance.
          use: true
          # Keep BuildKit state on cleanup. This is only useful on persistent self-hosted runners.
          keep-state: false
          # Cache buildx binary to GitHub Actions cache backend.
          cache-binary: true
          # Cleanup temp files and remove builder at the end of a job.
          cleanup: true
      # Build and push Docker images with Buildx.
      - name: ğŸ³ Docker âš™ï¸ build and â¬†ï¸ push images
        uses: docker/build-push-action@v6
        with:
          # Path to the Dockerfile.
          file: './docker/Dockerfile.NGINX1.28.0'
          # List of metadata for an image.
          labels: |
            org.opencontainers.image.vendor=BlitzSystemsPvtLtd.
          # Load is a shorthand for --output=type=docker
          load: false
          # List of target platforms for build.
          # Valid values: linux/amd64, linux/arm64
          platforms: linux/amd64
          # Push is a shorthand for --output=type=registry
          push: true
          # List of tags.
          tags: balajipothula/nginx:1.28.0
