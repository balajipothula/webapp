name: ğŸ—ï¸ Terraform Infra Provision
on:
  workflow_call:
    secrets:
      WEBAPP_DB_NAME:
        description: 'WebApp Database Name.'
        required: true
      WEBAPP_DB_MASTER_USERNAME:
        description: 'WebApp Database Master Username.'
        required: true
      WEBAPP_DB_MASTER_PASSWORD:
        description: 'WebApp Database Master Password.'
        required: true

env:
  # Setting verbosity of Terraform logs.
  TF_LOG: ERROR
  # Setting AWS Access Key Id and Secret Access Key.
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  terraform:
    name: ğŸ› ï¸ Running Terraform
    # GitHub Actions runner is ubuntu-22.04.
    runs-on: ubuntu-22.04
    # Environment is Development.
    environment: dev
    defaults:
      run:
        # Using bash shell.
        shell: bash
        # Setting working directory.
        # Also, by keeping '.' setting current terraform files running directory.
        working-directory: .
    steps:
      # Checkout a Git repository at a particular version.
      - name: ğŸ™ Git Checkout ğŸ“¥
        uses: actions/checkout@v3
        with:
          # Repository name with owner.
          repository: '${{ github.repository }}'
          # PAT (Personal Access Token) used to fetch the repository.
          token: '${{ github.token }}'
          # Whether to execute `git clean -ffdx && git reset --hard HEAD` before fetching.
          clean: true
          # Do a sparse checkout on given patterns.
          sparse-checkout: null
          # Specifies whether to use cone-mode when doing a sparse checkout.
          sparse-checkout-cone-mode: true
          # Number of commits to fetch.
          fetch-depth: 1
          # Whether to fetch tags, even if fetch-depth > 0.
          fetch-tags: false
          # Whether to download Git-LFS files
          lfs: false
          # Add repository path as safe.
          set-safe-directory: true
      # Gets the public IPv4 and IPv6 addreses of the current runner using latest Node
      - name: ğŸŒ Get Runner Public IP Address ğŸ“¡
        uses: candidob/get-runner-ip@v1.0.0
        id: ip
      # Installing the specified version of Terraform CLI on Runner.
      - name: ğŸ› ï¸ Terraform setup ğŸ“
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.4.0
      # Initialize a new or existing Terraform working directory by creating initial files,
      # loading any remote state, downloading modules, etc.
      - name: ğŸ› ï¸ Terraform initialization ğŸ”
        run: terraform init -input=false -reconfigure
        env:
          TF_WORKSPACE: default
      # Format Terraform configuration files adhere in to a canonical format.
      - name: ğŸ› ï¸ Terraform files formating ğŸ§¹
        run: terraform fmt
      # Check that all Terraform configuration files adhere to a canonical format.
      - name: ğŸ› ï¸ Terraform file format checking ğŸ”
        run: terraform fmt -check
      # Validate all Terraform configuration files.
      - name: ğŸ› ï¸ Terraform files validating âœ…
        run: terraform validate -no-color
      # Generates an execution plan for Terraform.
      - name: ğŸ› ï¸ Terraform plan generation ğŸ“„
        run: |
          terraform plan -input=false -out=webapp.tfplan                              \
            -var="github_runner_ip=${{ steps.ip.outputs.ipv4 }}/32"                   \
            -var="webapp_database_name=${{ secrets.WEBAPP_DB_NAME }}"                 \
            -var="webapp_db_master_username=${{ secrets.WEBAPP_DB_MASTER_USERNAME }}" \
            -var="webapp_db_master_password=${{ secrets.WEBAPP_DB_MASTER_PASSWORD }}"
        continue-on-error: false
      # Apply an execution plan for Terraform.
      - name: ğŸ› ï¸ Terraform plan applying ğŸš§
        run: terraform apply -auto-approve -input=false webapp.tfplan
